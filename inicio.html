<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In√≠cio</title>
     <link rel="icon" href="imagens/logo.png" type="image/png">
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="CSS/loading.css">
  <meta name="description" content="Sunseeker - Solu√ß√µes de energia solar para resid√™ncias e empresas. Inova√ß√£o em efici√™ncia energ√©tica.">
  <meta name="author" content="Sunseeker">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

</head>
<link rel="stylesheet" href="CSS/pagina_padrao.css" />
<style>
  .card:hover {
    transform: scale(1.03);
    transition: 0.3s ease;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  }

  section {
    padding-top: 3rem;
  }

  h2 {
    border-bottom: 2px solid #ffc107;
    padding-bottom: 0.5rem;
    margin-bottom: 2rem;
  }

  .dashboard-card {
    height: 400px;
    border-radius: 20px;
    overflow: hidden;
    background: #ffffff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s;
  }

  /* Estilos para o modo escuro */
  [data-theme="dark"] .dashboard-card {
    background-color: #2c3e50; /* Cor de fundo escura para os cards */
  }

  [data-theme="dark"] .dashboard-card:hover {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
  }

  /* Estilos para o Modal de Perfil em Modo Escuro */
  [data-theme="dark"] .profile-modal .modal-content {
    background-color: #2c3e50;
    color: #ecf0f1;
  }
  [data-theme="dark"] .profile-modal .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
  }
  [data-theme="dark"] .profile-modal .profile-email {
    color: #bdc3c7 !important;
  }
</style>
<body>
<!-- Tela de Loading -->
<div id="loading-screen">
    <div class="loading-content">
        <img src="imagens/logo.png" alt="Sunseeker Logo" class="logo-pulse">
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
        <!--<span id="loading-percent">0%</span>-->
    </div>
</div>

<!-- Tela de Loading 
<div id="loading-screen">
    <img src="imagens/logo.png" alt="Sunseeker Logo" class="logo-pulse">
</div>-->

  <!-- üîÜ CABE√áALHO -->
  <!-- Cabe√ßalho Melhorado -->
  <header class="header-custom d-flex justify-content-between align-items-center px-4 py-3" id="mainHeader">
    <!-- Indicador de status do Firebase; atualizado dinamicamente -->
    <div id="firebase-status" class="badge bg-secondary text-white" style="display:none;position:absolute;right:1rem;top:1rem;z-index:1050;">Firebase: --</div>
    <!-- Container do Logo -->
    <div class="d-flex align-items-center gap-3">
        <a href="inicio.html" class="logo-container text-decoration-none">
            <img src="imagens/logo.png" alt="Logotipo da Sunseeker" height="60" class="logo-img" />
        </a>
    </div>

    <!-- Navega√ß√£o Desktop -->
    <nav class="d-none d-lg-flex gap-3 align-items-center">
        <div class="nav-item">
            <a href="inicio.html" class="nav-button active">
                <i class="fas fa-home me-2"></i>
                <span>In√≠cio</span>
            </a>
        </div>
        <div class="nav-item">
            <a href="solucoes.html" class="nav-button">
                <i class="fas fa-lightbulb me-2"></i>
                <span>Solu√ß√µes</span>
            </a>
        </div>
        <div class="nav-item">
            <a href="produtos.html" class="nav-button">
                <i class="fas fa-box me-2"></i>
                <span>Produtos</span>
            </a>
        </div>
        <div class="nav-item">
            <a href="simulador.html" class="nav-button">
                <i class="fas fa-calculator me-2"></i>
                <span>Simulador</span>
            </a>
        </div>

        <div class="nav-item">
            <a href="sobre.html" class="nav-button">
                <i class="fas fa-info-circle me-2"></i>
                <span>Sobre</span>
            </a>
        </div>

        <div class="nav-item dropdown">
          <a class="nav-button dropdown-toggle" href="#" id="accessibilityDropdown" role="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
            <i class="fas fa-universal-access me-2"></i>
            <span>Acessibilidade</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="accessibilityDropdown">
            <li><h6 class="dropdown-header">Atalhos de Teclado</h6></li>
            <li><a class="dropdown-item" href="#" onclick="changeFontSize('increase')"><i class="fas fa-search-plus me-2"></i> Aumentar Fonte</a></li>
            <li><a class="dropdown-item" href="#" onclick="changeFontSize('decrease')"><i class="fas fa-search-minus me-2"></i> Diminuir Fonte</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="toggleLetterSpacing()"><i class="fas fa-text-width me-2"></i> Espa√ßamento de Letras (Alt L)</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="toggleContrast()"><i id="contrastIcon" class="fas fa-toggle-off me-2"></i> Alto Contraste</a></li>
            <li><a class="dropdown-item" href="#" onclick="toggleTheme()"><i class="fas fa-moon me-2"></i> <span id="themeText">Modo Escuro</span></a></li>
            <li><a class="dropdown-item" href="#" onclick="readPageAloud()"><i class="fas fa-volume-up me-2"></i> Ler em Voz Alta (Alt R)</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="resetAccessibility()"><i class="fas fa-undo me-2" style="color: #ff6b35;"></i> Resetar (Alt 0)</a></li>
          </ul>
        </div>

        <!-- Bot√£o de Conta/Perfil que abre o Modal -->
        <div class="nav-item">
          <a class="nav-button" href="#" id="userProfileButton" data-bs-toggle="modal" data-bs-target="#userProfileModal">
            <i class="fas fa-user-cog me-2"></i>
            <span>Conta</span>
          </a>
        </div>
    </nav>

    <!-- Bot√£o Menu Mobile -->
    <button class="d-lg-none mobile-menu-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#mobileNav" aria-controls="mobileNav" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars"></i>
    </button>
</header>

<!-- Menu Mobile Colaps√°vel -->
<div class="collapse mobile-nav d-lg-none" id="mobileNav">
  <div class="container-fluid py-3"></div>
    <nav class="d-flex flex-column gap-2">
      <a href="inicio.html" class="nav-button active">
        <i class="fas fa-home me-2"></i>
        <span>In√≠cio</span>
      </a>
      <a href="solucoes.html" class="nav-button">
        <i class="fas fa-lightbulb me-2"></i>
        <span>Solu√ß√µes</span>
      </a>
      <a href="produtos.html" class="nav-button">
        <i class="fas fa-box me-2"></i>
        <span>Produtos</span>
      </a>
      <a href="sobre.html" class="nav-button">
        <i class="fas fa-info-circle me-2"></i>
        <span>Sobre</span>
      </a>
      <a href="simulador.html" class="nav-button">
        <i class="fas fa-calculator me-2"></i>
        <span>Simulador</span>
      </a>
      <div class="nav-item dropdown">
        <a class="nav-button dropdown-toggle" href="#" id="mobileAccessibilityDropdown" role="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
          <i class="fas fa-universal-access me-2"></i>
          <span>Acessibilidade</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="mobileAccessibilityDropdown">
            <li><h6 class="dropdown-header">Atalhos de Teclado</h6></li>
            <li><a class="dropdown-item" href="#" onclick="changeFontSize('increase')"><i class="fas fa-search-plus me-2"></i> Aumentar Fonte (Alt +)</a></li>
            <li><a class="dropdown-item" href="#" onclick="changeFontSize('decrease')"><i class="fas fa-search-minus me-2"></i> Diminuir Fonte (Alt -)</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="toggleLetterSpacing()"><i class="fas fa-text-width me-2"></i> Espa√ßamento de Letras (Alt L)</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="toggleContrast()"><i id="contrastIconMobile" class="fas fa-toggle-off me-2"></i> Alto Contraste</a></li>
            <li><a class="dropdown-item" href="#" onclick="toggleTheme()"><i class="fas fa-moon me-2"></i> <span id="themeTextMobile">Modo Escuro</span></a></li>
            <li><a class="dropdown-item" href="#" onclick="readPageAloud()"><i class="fas fa-volume-up me-2"></i> Ler em Voz Alta (Alt R)</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="resetAccessibility()"><i class="fas fa-undo me-2" style="color: #ff6b35;"></i> Resetar (Alt 0)</a></li>
        </ul>
      </div>

      <!-- Bot√£o de Conta/Perfil Mobile que abre o Modal -->
      <div class="nav-item">
        <a class="nav-button" href="#" id="mobileUserProfileButton" data-bs-toggle="modal" data-bs-target="#userProfileModal">
          <i class="fas fa-user-cog me-2"></i>
          <span>Conta</span>
        </a>
      </div>
    </nav>
  </div>
</div>

    <!-- üìÑ CONTE√öDO -->
  <main class="container my-5">
    <section id="simulador" class="mb-5">
      <h2 class="fw-bold" id="dashboardTitle">
        Dashboard de <span id="userNameDisplay">...</span> <i class="fas fa-chart-line ms-2"></i>
      </h2>
      <p>Veja abaixo diferentes formas de visualiza√ß√£o da economia de energia com os sistemas da Sunseeker:</p>
      <div class="row g-4">
        <!-- üìà Linha -->
        <div class="col-md-6">
          <div class="dashboard-card" id="grafico-linha"></div>
        </div>
        <!-- üü† Pizza -->
        <div class="col-md-6">
          <div class="dashboard-card" id="grafico-pizza"></div>
        </div>
        <!-- üìä Coluna -->
        <div class="col-md-6">
          <div class="dashboard-card" id="grafico-coluna"></div>
        </div>
        <!-- üìâ Barra -->
        <div class="col-md-6">
          <div class="dashboard-card" id="grafico-barra"></div>
        </div>
        <!-- ‚ö° Energia Gerada -->
        <div class="col-12">
          <div class="dashboard-card" id="grafico-energia"></div>
        </div>
      </div>

      <!-- Tabela de Energia Total Gerada -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Energia Total Gerada</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="unit-select" class="form-label">Unidade de Energia:</label>
                <select id="unit-select" class="form-select">
                  <option value="kWh">kWh</option>
                  <option value="Wh">Wh</option>
                  <option value="mWh">mWh</option>
                </select>
              </div>
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Energia Total (<span id="unit-display">kWh</span>)</th>
                  </tr>
                </thead>
                <tbody id="energia-total-table">
                  <tr>
                    <td>Hoje</td>
                    <td id="energia-total-hoje">0.00</td>
                  </tr>
                  <tr>
                    <td>Esta Semana</td>
                    <td id="energia-total-semana">0.00</td>
                  </tr>
                  <tr>
                    <td>Este M√™s</td>
                    <td id="energia-total-mes">0.00</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- üìä Tabela de Energia Calculada pelo Firebase -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Energia Calculada (a partir dos registros armazenados)</h5>
            </div>
            <div class="card-body">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Per√≠odo</th>
                    <th>Energia (kWh)</th>
                    <th>Pot√™ncia M√©dia (W)</th>
                  </tr>
                </thead>
                <tbody id="energia-firebase-table">
                  <tr>
                    <td>Hoje</td>
                    <td id="firebase-energia-hoje">--</td>
                    <td id="firebase-media-hoje">--</td>
                  </tr>
                  <tr>
                    <td>Esta Semana</td>
                    <td id="firebase-energia-semana">--</td>
                    <td id="firebase-media-semana">--</td>
                  </tr>
                  <tr>
                    <td>Este M√™s</td>
                    <td id="firebase-energia-mes">--</td>
                    <td id="firebase-media-mes">--</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- üìà Gr√°fico Comparativo entre Usu√°rios -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="dashboard-card" id="grafico-comparativo"></div>
        </div>
      </div>
    </section>
  

//
    <p>Tens√£o: <span id="tensao">--</span></p>
<p>Corrente: <span id="corrente">--</span></p>
<p>Pot√™ncia: <span id="potencia">--</span></p>

<script src="script.js"></script>



<div id="tensao"></div>
<div id="corrente"></div>
<div id="potencia"></div>


  </main>

  <!-- üß† Gr√°ficos Google -->
  <script>
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(drawCharts);

    let energiaData;
    let energiaChart;

    function drawCharts() {
      // üìà Linha
      const linhaData = google.visualization.arrayToDataTable([

        ['M√™s', 'Economia (kWh)'],
        ['Jan', 320], ['Fev', 500], ['Mar', 820], ['Abr', 740], ['Mai', 920], ['Jun', 350]
      ]);
      const linhaOptions = {
        title: 'Economia Mensal',
        curveType: 'function',
        legend: { position: 'bottom' },
        colors: ['#FF914D']
      };
      new google.visualization.LineChart(document.getElementById('grafico-linha')).draw(linhaData, linhaOptions);

      // üü† Pizza
      const pizzaData = google.visualization.arrayToDataTable([
        ['Tipo', 'Instala√ß√µes'],
        ['Residencial', 50], ['Comercial', 35], ['Industrial', 25], ['Outros', 15]
      ]);
      const pizzaOptions = {
        title: 'Tipos de Instala√ß√µes',
        pieHole: 0.4,
        colors: ['#FFDE59', '#649AE1', '#FF914D', '#000000']
      };
      new google.visualization.PieChart(document.getElementById('grafico-pizza')).draw(pizzaData, pizzaOptions);

      // üìä Coluna
      const colunaData = google.visualization.arrayToDataTable([
        ['Casa', 'Sem Painel', 'Com Painel'],
        ['Casa 1', 1000, 400], ['Casa 2', 950, 380], ['Casa 3', 1100, 450],
      ]);
      const colunaOptions = {
        title: 'Consumo: Sem vs Com Painel',
        colors: ['#6c757d', '#FFDE59']
      };
      new google.visualization.ColumnChart(document.getElementById('grafico-coluna')).draw(colunaData, colunaOptions);

      // üìâ Barras
      const barraData = google.visualization.arrayToDataTable([
        ['Ano', 'Antes', 'Depois'],
        ['2022', 1250, 550], ['2023', 1100, 420], ['2024', 1180, 500],
      ]);
      const barraOptions = {
        title: 'Hist√≥rico de Consumo',
        bars: 'horizontal',
        colors: ['#6c757d', '#649AE1']
      };
      new google.visualization.BarChart(document.getElementById('grafico-barra')).draw(barraData, barraOptions);

      // ‚ö° Energia Gerada
      energiaData = new google.visualization.DataTable();
      energiaData.addColumn('string', 'Tempo');
      energiaData.addColumn('number', 'Pot√™ncia (W)');
      energiaChart = new google.visualization.LineChart(document.getElementById('grafico-energia'));
      const energiaOptions = {
        title: 'Energia Gerada em Tempo Real',
        curveType: 'function',
        legend: { position: 'bottom' },
        colors: ['#FF914D'],
        hAxis: { title: 'Tempo' },
        vAxis: { title: 'Pot√™ncia (W)' }
      };
      energiaChart.draw(energiaData, energiaOptions);
    }
    // DADOS INA TTESTE


// Atualiza a cada 1 segundo
setInterval(atualizarDados, 1000);
//DADOS IDA TESTE

  </script>
  <script>
    // Vari√°veis para armazenar energia acumulada continuamente
    let energiaHoje = parseFloat(localStorage.getItem('energiaHoje') || 0);
    let energiaSemana = parseFloat(localStorage.getItem('energiaSemana') || 0);
    let energiaMes = parseFloat(localStorage.getItem('energiaMes') || 0);

    async function atualizarDados() {
      try {
        const res = await fetch("http://192.168.0.104/dados"); // ‚ûú IP DO ESP32
        const dados = await res.json();

        document.getElementById("tensao").innerText = dados.tensao + " V";
        document.getElementById("corrente").innerText = dados.corrente + " A";
        document.getElementById("potencia").innerText = dados.potencia + " W";

        // Envia leitura ao Realtime Database (se a fun√ß√£o estiver dispon√≠vel)
        try {
          if (typeof writeReadingToFirebase === 'function') {
            writeReadingToFirebase(dados);
          }
        } catch (e) {
          console.error('Erro ao chamar writeReadingToFirebase:', e);
        }

        // Calcular energia gerada neste segundo (kWh)
        const potenciaKW = parseFloat(dados.potencia) / 1000; // Converter W para kW
        const energiaSegundo = potenciaKW / 3600; // Energia em 1 segundo

        // Acumular energia continuamente sem reset
        energiaHoje += energiaSegundo;
        energiaSemana += energiaSegundo;
        energiaMes += energiaSegundo;

        // Salvar no localStorage
        localStorage.setItem('energiaHoje', energiaHoje);
        localStorage.setItem('energiaSemana', energiaSemana);
        localStorage.setItem('energiaMes', energiaMes);

        // Atualizar tabela
        atualizarTabelaComUnidade();

        // Atualizar gr√°fico de energia
        if (energiaData && energiaChart) {
          const now = new Date();
          const timeString = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds();
          energiaData.addRow([timeString, parseFloat(dados.potencia)]);

          // Manter apenas os √∫ltimos 20 pontos
          if (energiaData.getNumberOfRows() > 20) {
            energiaData.removeRow(0);
          }

          energiaChart.draw(energiaData, {
            title: 'Energia Gerada em Tempo Real',
            curveType: 'function',
            legend: { position: 'bottom' },
            colors: ['#FF914D'],
            hAxis: { title: 'Tempo' },
            vAxis: { title: 'Pot√™ncia (W)' }
          });
        }

      } catch (e) {
        console.log("Erro ao buscar dados:", e);
      }
    }

    // Atualiza a cada 1 segundo
    setInterval(atualizarDados, 1000);
    atualizarDados();

    // Fun√ß√£o para converter energia baseada na unidade selecionada
    function converterEnergia(energiaKWh, unidade) {
      switch (unidade) {
        case 'Wh':
          return energiaKWh * 1000;
        case 'mWh':
          return energiaKWh * 1000000;
        default:
          return energiaKWh;
      }
    }

    // Fun√ß√£o para atualizar a tabela com a unidade selecionada
    function atualizarTabelaComUnidade() {
      const unidade = document.getElementById('unit-select').value;
      document.getElementById('unit-display').innerText = unidade;

      const energiaHojeConvertida = converterEnergia(energiaHoje, unidade);
      const energiaSemanaConvertida = converterEnergia(energiaSemana, unidade);
      const energiaMesConvertida = converterEnergia(energiaMes, unidade);

      document.getElementById("energia-total-hoje").innerText = energiaHojeConvertida.toFixed(6);
      document.getElementById("energia-total-semana").innerText = energiaSemanaConvertida.toFixed(6);
      document.getElementById("energia-total-mes").innerText = energiaMesConvertida.toFixed(6);
    }

    // Event listener para mudan√ßa de unidade
    document.getElementById('unit-select').addEventListener('change', atualizarTabelaComUnidade);

    // Atualizar tabela inicialmente
    atualizarTabelaComUnidade();
    </script>
    
<!-- ü¶∂ RODAP√â -->
<footer class="bg-dark text-light py-5">
  <div class="container">
    <div class="row">
      <div class="col-md-4 mb-3">
        <a href="index.html" class="d-inline-block mb-2">
          <img src="imagens/logo.png" alt="Sunseeker" height="48">
        </a>
        <p class="small mb-0">Sunseeker ‚Äî Solu√ß√µes e monitoramento de energia solar. Projeto acad√™mico.</p>
      </div>
      <div class="col-md-2 mb-3">
        <h6 class="text-uppercase small">Navega√ß√£o</h6>
        <ul class="list-unstyled small">
          <li><a class="text-light text-decoration-none" href="inicio.html">In√≠cio</a></li>
          <li><a class="text-light text-decoration-none" href="solucoes.html">Solu√ß√µes</a></li>
          <li><a class="text-light text-decoration-none" href="produtos.html">Produtos</a></li>
          <li><a class="text-light text-decoration-none" href="simulador.html">Simulador</a></li>
          <li><a class="text-light text-decoration-none" href="sobre.html">Sobre</a></li>
        </ul>
      </div>
      <div class="col-md-3 mb-3">
        <h6 class="text-uppercase small">Suporte</h6>
        <p class="small mb-1">contato@sunseeker.com</p>
        <p class="small mb-0">WhatsApp: (11) 99727-4119</p>
      </div>
      <div class="col-md-3 mb-3">
        <h6 class="text-uppercase small">Siga-nos</h6>
        <p class="small mb-1">Instagram ¬∑ LinkedIn ¬∑ YouTube</p>
        <p class="small mb-0"><a class="text-light text-decoration-none" href="termos-e-privacidade.html">Termos e Privacidade</a></p>
      </div>
    </div>
    <div class="text-center pt-4 border-top border-secondary mt-3">
      <small>¬© 2025 Sunseeker. Todos os direitos reservados.</small>
    </div>
  </div>
</footer>



<!-- Modal de Perfil do Usu√°rio -->
<div class="modal fade profile-modal" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="userProfileModalLabel">Seu Perfil</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img src="imagens/avatar_padrao.png" alt="Foto do Perfil" id="modalProfilePic" class="profile-pic mb-3">
        <h4 id="modalUserName" class="profile-name">Carregando...</h4>
        <p id="modalUserEmail" class="profile-email text-muted">carregando.email@...</p>
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <button type="button" id="modalLogoutButton" class="btn btn-danger">
          <i class="fas fa-sign-out-alt me-2"></i>Sair da Conta
        </button>
      </div>
    </div>
  </div>
</div>

 <!-- ‚úÖ Bootstrap JS -->
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

 <!-- Scripts -->
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCzsKoNUO3pfWXr7kSBfZ3WEls_2TBhWx0",
      authDomain: "sunseeker-11685.firebaseapp.com",
      projectId: "sunseeker-11685",
      storageBucket: "sunseeker-11685.appspot.com",
      messagingSenderId: "997372628224",
      appId: "1:997372628224:web:50ccfbfe938a0442bb37e5"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <!-- Realtime Database (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script>
    // Inicializa refer√™ncia ao Realtime Database (SDK compat)
    const database = firebase.database();

    // Fun√ß√£o para gravar leituras vindas do ESP32 no Realtime Database
    // Agora grava por usu√°rio autenticado em: /users/{uid}/esp32/{readings,last}
    // Se n√£o houver usu√°rio autenticado, grava em /public/esp32 para testes.
    // Esta vers√£o atualiza o indicador visual de status (sucesso/erro).
    let firebaseStatusTimer = null;
    function setFirebaseStatus(message, success) {
      const el = document.getElementById('firebase-status');
      if (!el) return;
      el.style.display = 'inline-block';
      el.textContent = 'Firebase: ' + message;
      el.className = 'badge ' + (success ? 'bg-success text-white' : 'bg-danger text-white');
      // Limpa qualquer timer anterior
      if (firebaseStatusTimer) clearTimeout(firebaseStatusTimer);
      // Auto-esconde ap√≥s 4 segundos
      firebaseStatusTimer = setTimeout(() => {
        el.style.display = 'none';
      }, 4000);
    }

    function writeReadingToFirebase(dados) {
      try {
        const now = Date.now();
        const reading = {
          tensao: Number(dados.tensao),
          corrente: Number(dados.corrente),
          potencia: Number(dados.potencia),
          timestamp: now
        };

        const auth = firebase.auth();
        const user = auth.currentUser;

        // Define a refer√™ncia base dependendo se o usu√°rio est√° logado
        let basePath = 'public/esp32';
        if (user && user.uid) {
          basePath = `users/${user.uid}/esp32`;
        } else {
          console.warn('Nenhum usu√°rio autenticado. Gravando em /public/esp32. Configure autentica√ß√£o para registrar por usu√°rio.');
        }

        // Empurra um novo registro para /users/{uid}/esp32/readings ou /public/esp32/readings
        database.ref(`${basePath}/readings`).push(reading)
          .then(() => {
            setFirebaseStatus('Enviado', true);
          })
          .catch(function(err){
            console.error('Erro ao gravar leitura (push):', err);
            setFirebaseStatus('Erro ao enviar', false);
          });

        // Atualiza √∫ltimo valor em /users/{uid}/esp32/last ou /public/esp32/last
        database.ref(`${basePath}/last`).set(reading)
          .catch(function(err){
            console.error('Erro ao gravar leitura (set last):', err);
            // Mostra erro tamb√©m se set falhar (push pode ter ocorrido antes)
            setFirebaseStatus('Erro ao atualizar last', false);
          });
      } catch (e) {
        console.error('Erro em writeReadingToFirebase:', e);
        setFirebaseStatus('Erro interno', false);
      }
    }
  </script>
<script src="JS/cabe√ßalho.js"></script>
<script src="JS/acessibilidade.js"></script>
<script src="JS/loading.js"></script>
<!-- VLibras -->
<div vw class="enabled">
  <div vw-access-button class="active"></div>
  <div vw-plugin-wrapper>
    <div class="vw-plugin-top-wrapper"></div>
  </div>
</div>
<script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
<script>
  new window.VLibras.Widget('https://vlibras.gov.br/app');
</script>
<script src="JS/perfil.js"></script>

<!-- Subscri√ß√£o de leituras por usu√°rio e desenho do gr√°fico (Google Charts) -->
<script>
  let userReadingsRef = null;
  let allUsersData = {}; // Armazena dados de todos os usu√°rios

  // ===== (A) FUN√á√ïES DE C√ÅLCULO DE ENERGIA =====
  function calculateEnergyMetrics(rows) {
    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).getTime();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

    let energyToday = 0, energyWeek = 0, energyMonth = 0;
    let countToday = 0, countWeek = 0, countMonth = 0;
    let potentialToday = 0, potentialWeek = 0, potentialMonth = 0;

    for (let i = 1; i < rows.length; i++) {
      const prev = rows[i - 1];
      const curr = rows[i];
      const timeDiff = (curr.timestamp - prev.timestamp) / 1000 / 3600; // horas
      const avgPower = (Number(prev.potencia) + Number(curr.potencia)) / 2 / 1000; // kW
      const energyInterval = avgPower * timeDiff; // kWh

      const currTime = curr.timestamp;

      if (currTime >= todayStart) {
        energyToday += energyInterval;
        countToday++;
        potentialToday += Number(curr.potencia);
      }
      if (currTime >= weekStart) {
        energyWeek += energyInterval;
        countWeek++;
        potentialWeek += Number(curr.potencia);
      }
      if (currTime >= monthStart) {
        energyMonth += energyInterval;
        countMonth++;
        potentialMonth += Number(curr.potencia);
      }
    }

    return {
      today: { energy: energyToday, avgPower: countToday > 0 ? potentialToday / countToday : 0 },
      week: { energy: energyWeek, avgPower: countWeek > 0 ? potentialWeek / countWeek : 0 },
      month: { energy: energyMonth, avgPower: countMonth > 0 ? potentialMonth / countMonth : 0 }
    };
  }

  function updateEnergyTables() {
    // Atualiza tabela de energia calculada pelo Firebase
    const auth = firebase.auth();
    const uid = auth.currentUser ? auth.currentUser.uid : null;

    if (uid && allUsersData[uid]) {
      const metrics = allUsersData[uid].metrics;
      document.getElementById('firebase-energia-hoje').textContent = metrics.today.energy.toFixed(4);
      document.getElementById('firebase-media-hoje').textContent = metrics.today.avgPower.toFixed(2);
      document.getElementById('firebase-energia-semana').textContent = metrics.week.energy.toFixed(4);
      document.getElementById('firebase-media-semana').textContent = metrics.week.avgPower.toFixed(2);
      document.getElementById('firebase-energia-mes').textContent = metrics.month.energy.toFixed(4);
      document.getElementById('firebase-media-mes').textContent = metrics.month.avgPower.toFixed(2);
    }
  }

  // ===== (B) SUBSCRI√á√ÉO POR USU√ÅRIO COM TOOLTIP =====
  function attachReadingsListenerForBasePath(basePath) {
    try {
      if (typeof database === 'undefined' || typeof google === 'undefined' || !google.visualization) return;

      // Desliga listener anterior se existir
      if (userReadingsRef) {
        try { userReadingsRef.off(); } catch(e) { console.warn('Erro ao desligar listener anterior', e); }
        userReadingsRef = null;
      }

      userReadingsRef = database.ref(basePath + '/readings').limitToLast(200);

      userReadingsRef.on('value', snapshot => {
        const auth = firebase.auth();
        const uid = auth.currentUser ? auth.currentUser.uid : 'public';

        // Monta DataTable com coluna datetime
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('datetime', 'Tempo');
        dataTable.addColumn('number', 'Pot√™ncia (W)');
        dataTable.addColumn({ type: 'string', role: 'tooltip', p: { html: true } });

        const rows = [];
        snapshot.forEach(child => {
          const val = child.val();
          if (val && val.timestamp) rows.push(val);
        });

        // Ordena por timestamp
        rows.sort((a,b) => a.timestamp - b.timestamp);

        // Calcula m√©tricas
        const metrics = calculateEnergyMetrics(rows);
        allUsersData[uid] = { rows, metrics };

        rows.forEach(r => {
          const ts = Number(r.timestamp);
          const pot = Number(r.potencia || 0);
          const tens = Number(r.tensao || 0);
          const corr = Number(r.corrente || 0);
          const dateStr = new Date(ts).toLocaleString('pt-BR');
          
          // HTML para tooltip (op√ß√£o html:true)
          const tooltip = `<div style="background:#fd9; padding:5px; border-radius:3px; border:1px solid #333;">
            <strong>${dateStr}</strong><br/>
            Pot√™ncia: ${pot.toFixed(1)} W<br/>
            Tens√£o: ${tens.toFixed(2)} V<br/>
            Corrente: ${corr.toFixed(3)} A
          </div>`;

          dataTable.addRow([new Date(ts), pot, tooltip]);
        });

        updateEnergyTables();

        const opts = {
          title: 'Energia Gerada em Tempo Real (com dados armazenados)',
          curveType: 'function',
          legend: { position: 'bottom' },
          colors: ['#FF914D'],
          hAxis: { title: 'Tempo', format: 'HH:mm:ss' },
          vAxis: { title: 'Pot√™ncia (W)' },
          tooltip: { isHtml: true, trigger: 'focus' }
        };

        // Desenha no container existente
        const container = document.getElementById('grafico-energia');
        if (container) {
          const chart = new google.visualization.LineChart(container);
          chart.draw(dataTable, opts);
        }

        // Atualiza status
        const count = rows.length;
        console.log('Leituras carregadas (', basePath, '):', count);
        const statusEl = document.getElementById('firebase-status');
        if (statusEl) {
          statusEl.style.display = 'inline-block';
          statusEl.textContent = 'Registros: ' + count;
          statusEl.className = 'badge bg-info text-white';
          setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
        }
      });

    } catch (e) {
      console.error('Erro em attachReadingsListenerForBasePath:', e);
    }
  }

  // ===== (C) CARREGAMENTO DE TODOS OS USU√ÅRIOS E GR√ÅFICO COMPARATIVO =====
  function loadAllUsersComparative() {
    try {
      // Carrega lista de usu√°rios
      database.ref('users').once('value', snapshot => {
        const usersList = [];
        snapshot.forEach(userSnap => {
          usersList.push(userSnap.key);
        });

        // Carrega √∫ltimas leituras de cada usu√°rio
        let loadedCount = 0;
        usersList.forEach(uid => {
          database.ref(`users/${uid}/esp32/last`).once('value', snap => {
            const data = snap.val();
            if (data) {
              allUsersData[uid] = allUsersData[uid] || {};
              allUsersData[uid].last = data;
            }
            loadedCount++;

            // Quando todos os usu√°rios foram carregados, desenha gr√°fico comparativo
            if (loadedCount === usersList.length) {
              drawComparativeChart();
            }
          });
        });

        if (usersList.length === 0) {
          console.log('Nenhum usu√°rio encontrado');
        }
      });
    } catch (e) {
      console.error('Erro em loadAllUsersComparative:', e);
    }
  }

  function drawComparativeChart() {
    try {
      if (typeof google === 'undefined' || !google.visualization) return;

      const dataTable = new google.visualization.DataTable();
      dataTable.addColumn('string', 'Usu√°rio');
      dataTable.addColumn('number', 'Pot√™ncia Atual (W)');
      dataTable.addColumn('number', 'Energia Hoje (kWh)');

      const auth = firebase.auth();
      const currentUid = auth.currentUser ? auth.currentUser.uid : null;

      Object.keys(allUsersData).forEach(uid => {
        const data = allUsersData[uid];
        const pot = data.last ? Number(data.last.potencia || 0) : 0;
        const energy = data.metrics ? data.metrics.today.energy : 0;
        
        // Marca o usu√°rio atual com asterisco
        const label = uid === currentUid ? uid.substring(0, 8) + '* (voc√™)' : uid.substring(0, 8);
        dataTable.addRow([label, pot, energy]);
      });

      const opts = {
        title: 'Comparativo entre Usu√°rios (Pot√™ncia Atual vs Energia Hoje)',
        bars: 'horizontal',
        colors: ['#FF914D', '#649AE1'],
        legend: { position: 'bottom' },
        hAxis: { title: 'Valor' }
      };

      const container = document.getElementById('grafico-comparativo');
      if (container) {
        const chart = new google.visualization.BarChart(container);
        chart.draw(dataTable, opts);
      }
    } catch (e) {
      console.error('Erro em drawComparativeChart:', e);
    }
  }

  // ===== INICIALIZA√á√ÉO =====
  // Observa mudan√ßas no estado de autentica√ß√£o para trocar a fonte de dados
  firebase.auth().onAuthStateChanged(user => {
    if (user && user.uid) {
      attachReadingsListenerForBasePath(`users/${user.uid}/esp32`);
    } else {
      // Fallback para public (√∫til para testes sem login)
      attachReadingsListenerForBasePath('public/esp32');
    }

    // Carrega comparativo de todos os usu√°rios
    loadAllUsersComparative();
  });

  // Atualiza comparativo a cada 10 segundos
  setInterval(loadAllUsersComparative, 10000);

  // Cleanup
  window.addEventListener('beforeunload', () => {
    try { if (userReadingsRef) userReadingsRef.off(); } catch(e){}
  });
</script>

</body>
</html>